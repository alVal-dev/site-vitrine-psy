---
import { type Locale } from "../../i18n";

interface Props {
  lang: Locale;
}

const { lang } = Astro.props;

const content = {
  fr: {
    title: "Prendre rendez-vous",
    subtitle: "Choisissez votre mode de contact préféré",
    phone: "Par téléphone",
    phoneDesc: "Appelez directement pour fixer un rendez-vous",
    phoneNumber: "+33 7 XX XX XX XX",
    email: "Par email",
    emailDesc: "Envoyez-moi un message avec vos disponibilités",
    emailAddress: "contact@evelinvalcarce.fr",
    rdvlib: "à venir",
    rdvlibDesc: "Réservez en ligne 24h/24",
    rdvlibUrl: "",
    close: "Fermer",
    hours: "Horaires : Lun-Ven 9h-19h",
  },
  es: {
    title: "Pedir cita",
    subtitle: "Elija su método de contacto preferido",
    phone: "Por teléfono",
    phoneDesc: "Llame directamente para fijar una cita",
    phoneNumber: "+33 7 XX XX XX XX",
    email: "Por email",
    emailDesc: "Envíeme un mensaje con sus disponibilidades",
    emailAddress: "contact@evelinvalcarce.fr",
    rdvlib: "Doctolib",
    rdvlibDesc: "Reserve en línea 24h/24",
    rdvlibUrl: "https://www.doctolib.fr/",
    close: "Cerrar",
    hours: "Horarios: Lun-Vie 9h-19h",
  },
};

const c = content[lang];
---

<div id="appointment-modal-root">
  <div 
    id="modal-overlay"
    class="fixed inset-0 z-100 hidden bg-black/50 backdrop-blur-sm transition-opacity duration-300"
    aria-hidden="true"
  ></div>
  <div
    id="appointment-modal"
    class="fixed inset-0 z-101 hidden items-center justify-center p-4"
    role="dialog"
    aria-modal="true"
    aria-labelledby="modal-title"
    aria-describedby="modal-description"
  >
    <div 
      class="relative w-full max-w-lg transform rounded-2xl bg-white p-6 shadow-2xl transition-all duration-300 sm:p-8"
      id="modal-content"
    >
      <!-- Bouton fermer -->
      <button
        type="button"
        id="modal-close-btn"
        class="absolute right-4 top-4 rounded-full p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 focus:outline-none 
               focus:ring-2 focus:ring-rose-400"
        aria-label={c.close}
      >
        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Header -->
      <div class="mb-6 text-center">
        <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-rose-100">
          <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <h2 id="modal-title" class="font-serif text-2xl text-gray-800 sm:text-3xl">
          {c.title}
        </h2>
        <p class="mt-2 text-gray-600">{c.subtitle}</p>
      </div>

      <!-- Options de contact -->
      <div class="space-y-4">
        <!-- Téléphone -->
        <a
          href={`tel:${c.phoneNumber.replace(/\s/g, '')}`}
          class="flex items-center gap-4 rounded-xl border-2 border-gray-100 p-4 transition-all hover:border-rose-200 hover:bg-rose-50 focus:outline-none focus:ring-2 focus:ring-rose-400"
        >
          <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-green-100">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-semibold text-gray-800">{c.phone}</p>
            <p class="text-sm text-gray-500">{c.phoneDesc}</p>
            <p class="mt-1 text-sm font-medium text-rose-600">{c.phoneNumber}</p>
          </div>
          <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
          </svg>
        </a>

        <!-- Email -->
        <a
          href={`mailto:${c.emailAddress}?subject=${encodeURIComponent(lang === 'fr' ? 'Demande de rendez-vous' : 'Solicitud de cita')}`}
          class="flex items-center gap-4 rounded-xl border-2 border-gray-100 p-4 transition-all hover:border-rose-200 hover:bg-rose-50 
                focus:outline-none focus:ring-2 focus:ring-rose-400"
        >
          <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-blue-100">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-semibold text-gray-800">{c.email}</p>
            <p class="text-sm text-gray-500">{c.emailDesc}</p>
            <p class="mt-1 text-sm font-medium text-rose-600">{c.emailAddress}</p>
          </div>
          <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
          </svg>
        </a>

        <!-- Gestion rendez vous automatisé -->
        <a
          href={c.rdvlibUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center gap-4 rounded-xl border-2 border-gray-100 p-4 transition-all hover:border-rose-200 hover:bg-rose-50 
                focus:outline-none focus:ring-2 focus:ring-rose-400"
        >
          <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-purple-100">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-semibold text-gray-800">{c.rdvlib}</p>
            <p class="text-sm text-gray-500">{c.rdvlibDesc}</p>
          </div>
          <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
        </a>
      </div>

      <!-- Footer -->
      <p class="mt-6 text-center text-sm text-gray-500">
        {c.hours}
      </p>
    </div>
  </div>
</div>

<script>
function initModal() {
  const overlay = document.getElementById('modal-overlay');
  const modal = document.getElementById('appointment-modal');
  const closeBtn = document.getElementById('modal-close-btn');
  const modalContent = document.getElementById('modal-content');

  if (!overlay || !modal || !closeBtn || !modalContent) return;
  if (modal.dataset.init) return;
  modal.dataset.init = 'true';

  const TRANSITION_MS = 200;
  let previousFocus: HTMLElement | null = null;

  const openModal = () => {
    previousFocus = document.activeElement as HTMLElement;

    overlay.classList.remove('hidden');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';

    requestAnimationFrame(() => {
      overlay.classList.add('opacity-100');
      modalContent.classList.add('scale-100', 'opacity-100');
      modalContent.classList.remove('scale-95', 'opacity-0');
    });

    closeBtn.focus();
  };

  const closeModal = () => {
    overlay.classList.remove('opacity-100');
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');

    setTimeout(() => {
      overlay.classList.add('hidden');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      previousFocus?.focus();
    }, TRANSITION_MS);
  };

  // Ouverture
  document.querySelectorAll('[data-open-modal="appointment"]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      openModal();
    });
  });

  // Fermeture
  closeBtn.addEventListener('click', closeModal);
  overlay.addEventListener('click', closeModal);
  modalContent.addEventListener('click', (e) => e.stopPropagation());

  // Clavier
  document.addEventListener('keydown', (e) => {
    if (modal.classList.contains('hidden')) return;

    if (e.key === 'Escape') {
      closeModal();
      return;
    }

    if (e.key === 'Tab') {
      const focusable = modalContent.querySelectorAll<HTMLElement>('button, a[href]');
      const first = focusable[0];
      const last = focusable[focusable.length - 1];

      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }
  });

  // État initial
  modalContent.classList.add('scale-95', 'opacity-0');
}

document.addEventListener('DOMContentLoaded', initModal);
document.addEventListener('astro:after-swap', initModal);
</script>

<style>
  #modal-overlay {
    opacity: 0;
    transition: opacity 0.2s ease-out;
  }
  
  #modal-content {
    transition: transform 0.2s ease-out, opacity 0.2s ease-out;
  }
</style>